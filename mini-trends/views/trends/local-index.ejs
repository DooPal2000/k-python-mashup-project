<% layout('layouts/boilerplate')%>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- 검색 헤더 -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-success">지역 트렌드 검색</h1>
            <p class="lead text-muted">지역별 업체 및 장소의 인기 트렌드를 분석하세요</p>
        </div>

        <!-- 검색 폼 -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-body p-4">
                <form id="localSearchForm" class="validated-form" novalidate>
                    <div class="input-group input-group-lg mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="searchQuery" 
                            name="query"
                            placeholder="지역 검색어를 입력하세요 (예: 강남 맛집, 홍대 카페)" 
                            required
                            aria-label="검색어 입력"
                        >
                        <button class="btn btn-success px-4" type="submit" id="searchBtn">
                            <i class="bi bi-search"></i> 검색
                        </button>
                        <div class="invalid-feedback">
                            검색어를 입력해주세요.
                        </div>
                    </div>
                    
                    <!-- 검색 옵션 -->
                    <div class="row">
                        <div class="col-md-6">
                            <label for="displayCount" class="form-label small">결과 수</label>
                            <select class="form-select form-select-sm" id="displayCount" name="display">
                                <option value="1">1개</option>
                                <option value="3">3개</option>
                                <option value="5" selected>5개</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="sortOption" class="form-label small">정렬 기준</label>
                            <select class="form-select form-select-sm" id="sortOption" name="sort">
                                <option value="random" selected>정확도순</option>
                                <option value="comment">리뷰 많은순</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 로딩 스피너 -->
        <div id="loadingSpinner" class="text-center d-none my-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">검색 중입니다...</p>
        </div>

        <!-- 검색 결과 영역 -->
        <div id="searchResults">
            <div class="alert alert-info border-0 shadow-sm" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>
                지역 검색어를 입력하여 업체 및 장소의 트렌드를 확인해보세요.
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<script>
document.getElementById('localSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const query = document.getElementById('searchQuery').value.trim();
    const display = document.getElementById('displayCount').value;
    const sort = document.getElementById('sortOption').value;
    
    if (!query) return;
    
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchBtn').disabled = true;
    
    try {
        const response = await axios.get('/trends/local/search', {
            params: { query, display, sort }
        });
        
        displayLocalResults(response.data, query);
    } catch (error) {
        console.error('검색 오류:', error);
        Swal.fire({
            icon: 'error',
            title: '검색 실패',
            text: error.response?.data?.message || '검색 중 오류가 발생했습니다.',
        });
    } finally {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('searchBtn').disabled = false;
    }
});

function displayLocalResults(data, query) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (!data.items || data.items.length === 0) {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning border-0 shadow-sm" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                '<strong>${query}</strong>' 검색 결과가 없습니다.
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                '<strong class="text-success">${query}</strong>' 검색 결과 
                <span class="badge bg-secondary">${data.total.toLocaleString()}개</span>
            </h5>
        </div>
    `;
    
    data.items.forEach((item, index) => {
        const cleanTitle = item.title.replace(/<\/?b>/g, '');
        const cleanCategory = item.category.replace(/&gt;/g, ' > ');
        const hasRoadAddress = item.roadAddress && item.roadAddress.trim();
        
        html += `
            <div class="card mb-3 border-0 shadow-sm hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">
                                ${item.link ? 
                                    `<a href="${item.link}" target="_blank" class="text-decoration-none text-dark">${cleanTitle}</a>` :
                                    cleanTitle
                                }
                                <span class="badge bg-light text-dark ms-2">${index + 1}</span>
                            </h6>
                            <small class="text-muted">
                                <i class="bi bi-tag-fill me-1"></i>${cleanCategory}
                            </small>
                        </div>
                    </div>
                    
                    ${item.description ? `<p class="card-text text-muted small mb-2">${item.description}</p>` : ''}
                    
                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="bi bi-geo-alt-fill me-1 text-danger"></i>
                                ${hasRoadAddress ? item.roadAddress : item.address}
                            </small>
                        </div>
                        ${item.telephone ? `
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="bi bi-telephone-fill me-1 text-primary"></i>
                                <a href="tel:${item.telephone}" class="text-decoration-none">${item.telephone}</a>
                            </small>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${item.mapx && item.mapy ? `
                    <div class="mt-2">
                        <a href="https://map.naver.com/v5/search/${encodeURIComponent(cleanTitle)}?c=${item.mapx},${item.mapy},15,0,0,0,dh" 
                           target="_blank" 
                           class="btn btn-sm btn-outline-success">
                            <i class="bi bi-map me-1"></i>지도 보기
                        </a>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}
</script>

<style>
.hover-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.hover-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
</style>
