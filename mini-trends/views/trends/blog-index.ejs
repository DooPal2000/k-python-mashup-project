<% layout('layouts/boilerplate')%>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- 검색 헤더 -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">Trendis 블로그 검색</h1>
                <p class="lead text-muted">실시간 트렌드를 분석하고 인사이트를 발견하세요</p>
            </div>

            <!-- 검색 폼 -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-body p-4">
                    <form id="searchForm" class="validated-form" novalidate>
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" id="searchQuery" name="query"
                                placeholder="검색어를 입력하세요 (예: 인공지능, K-POP)" required aria-label="검색어 입력">
                            <button class="btn btn-primary px-4" type="submit" id="searchBtn">
                                <i class="bi bi-search"></i> 검색
                            </button>
                            <div class="invalid-feedback">
                                검색어를 입력해주세요.
                            </div>
                        </div>

                        <!-- 검색 옵션 -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="displayCount" class="form-label small">결과 수</label>
                                <select class="form-select form-select-sm" id="displayCount" name="display">
                                    <option value="10">10개</option>
                                    <option value="20" selected>20개</option>
                                    <option value="50">50개</option>
                                    <option value="100">100개</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="sortOption" class="form-label small">정렬 기준</label>
                                <select class="form-select form-select-sm" id="sortOption" name="sort">
                                    <option value="sim" selected>정확도순</option>
                                    <option value="date">최신순</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 로딩 스피너 -->
            <div id="loadingSpinner" class="text-center d-none my-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">검색 중입니다...</p>
            </div>

            <!-- 검색 결과 영역 -->
            <div id="searchResults">
                <!-- 초기 안내 메시지 -->
                <div class="alert alert-info border-0 shadow-sm" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    검색어를 입력하여 네이버 블로그의 최신 트렌드를 분석해보세요.
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <script>
        document.getElementById('searchForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const query = document.getElementById('searchQuery').value.trim();
            const display = document.getElementById('displayCount').value;
            const sort = document.getElementById('sortOption').value;

            if (!query) {
                return;
            }

            // UI 업데이트
            document.getElementById('loadingSpinner').classList.remove('d-none');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            try {
                const response = await axios.get('/trends/blog/search', {
                    params: { query, display, sort }
                });

                displayResults(response.data, query);
            } catch (error) {
                console.error('검색 오류:', error);
                Swal.fire({
                    icon: 'error',
                    title: '검색 실패',
                    text: error.response?.data?.message || '검색 중 오류가 발생했습니다.',
                });
            } finally {
                document.getElementById('loadingSpinner').classList.add('d-none');
                document.getElementById('searchBtn').disabled = false;
            }
        });

        function displayResults(data, query) {
            const resultsDiv = document.getElementById('searchResults');

            if (!data.items || data.items.length === 0) {
                resultsDiv.innerHTML = `
            <div class="alert alert-warning border-0 shadow-sm" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                '<strong>${query}</strong>' 검색 결과가 없습니다.
            </div>
        `;
                return;
            }

            // 결과 헤더
            let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                '<strong class="text-primary">${query}</strong>' 검색 결과 
                <span class="badge bg-secondary">${data.total.toLocaleString()}개</span>
            </h5>
        </div>
    `;

            // 각 검색 결과
            data.items.forEach((item, index) => {
                const cleanTitle = item.title.replace(/<\/?b>/g, '');
                const cleanDescription = item.description.replace(/<\/?b>/g, '');
                // postdate를 YYYY-MM-DD 형식으로 변환
                const dateStr = item.postdate; // "20250919"
                const formattedDate = `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)}`; // "2025-09-19"

                // const formattedDate = postDate.toLocaleDateString('ko-KR');

                html += `
            <div class="card mb-3 border-0 shadow-sm hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            <a href="${item.link}" target="_blank" class="text-decoration-none text-dark stretched-link">
                                ${cleanTitle}
                            </a>
                        </h6>
                        <span class="badge bg-light text-dark ms-2">${index + 1}</span>
                    </div>
                    <p class="card-text text-muted small mb-2">${cleanDescription}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-person-circle me-1"></i>${item.bloggername}
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>${formattedDate}
                        </small>
                    </div>
                </div>
            </div>
        `;
            });

            resultsDiv.innerHTML = html;
        }
    </script>

    <style>
        .hover-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }

        .input-group-lg .form-control {
            border-radius: 0.5rem 0 0 0.5rem;
        }

        .input-group-lg .btn {
            border-radius: 0 0.5rem 0.5rem 0;
        }

        #searchResults .card-title a:hover {
            color: #0d6efd !important;
        }
    </style>