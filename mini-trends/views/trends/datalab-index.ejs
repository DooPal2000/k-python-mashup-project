<% layout('layouts/boilerplate')%>

    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- 검색 헤더 -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">데이터랩 트렌드 분석</h1>
                <p class="lead text-muted">키워드별 검색량 추이를 시각화하여 트렌드를 분석하세요</p>
            </div>

            <!-- 검색 폼 -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-body p-4">
                    <form id="datalabForm" class="validated-form" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">시작 날짜</label>
                                <input type="date" class="form-control" id="startDate" name="startDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">종료 날짜</label>
                                <input type="date" class="form-control" id="endDate" name="endDate" required>
                            </div>
                        </div>


                        <div class="row mb-3">

                            <div class="col-md-3">
                                <label for="timeUnit" class="form-label">시간 단위</label>
                                <select class="form-select" id="timeUnit" name="timeUnit" required>
                                    <option value="date">일별</option>
                                    <option value="week">주별</option>
                                    <option value="month" selected>월별</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="device" class="form-label">기기</label>
                                <select class="form-select" id="device" name="device">
                                    <option value="">전체</option>
                                    <option value="pc">PC</option>
                                    <option value="mo">모바일</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="gender" class="form-label">성별</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="">전체</option>
                                    <option value="m">남성</option>
                                    <option value="f">여성</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="ages" class="form-label">연령대</label>
                                <select class="form-select" id="ages" name="ages[]" multiple required>
                                    <option value="1">10대</option>
                                    <option value="2">20대</option>
                                    <option value="3">30대</option>
                                    <option value="4">40대</option>
                                    <option value="5">50대</option>
                                    <option value="6">60대</option>
                                    <option value="7">70대 이상</option>
                                </select>
                                <small class="form-text text-muted">Ctrl(또는 Command) 키를 눌러 다중 선택 가능</small>
                            </div>
                        </div>

                        <!-- 키워드 그룹 -->
                        <div id="keywordGroups">
                            <div class="keyword-group mb-3 p-3 border rounded bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0 fw-bold">키워드 그룹 1</label>
                                </div>
                                <input type="text" class="form-control mb-2" placeholder="그룹 이름" name="groupName[]"
                                    required>
                                <input type="text" class="form-control keyword-input"
                                    placeholder="키워드 (쉼표로 구분, 예: 한글,korean)" name="keywords[]" required>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-outline-primary" id="addGroupBtn">
                                <i class="bi bi-plus-circle me-1"></i>키워드 그룹 추가
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="removeGroupBtn">
                                <i class="bi bi-dash-circle me-1"></i>그룹 제거
                            </button>
                        </div>

                        <button class="btn btn-primary btn-lg w-100" type="submit" id="searchBtn">
                            <i class="bi bi-bar-chart-line me-2"></i>트렌드 분석 시작
                        </button>
                    </form>
                </div>
            </div>

            <!-- 로딩 스피너 -->
            <div id="loadingSpinner" class="text-center d-none my-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">데이터 분석 중입니다...</p>
            </div>

            <!-- 검색 결과 영역 -->
            <div id="searchResults"></div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <script>
        // 날짜 초기화 (최근 1년)
        const today = new Date();
        const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('startDate').valueAsDate = oneYearAgo;

        let groupCount = 1;

        // 키워드 그룹 추가
        document.getElementById('addGroupBtn').addEventListener('click', function () {
            if (groupCount >= 5) {
                Swal.fire('알림', '최대 5개 그룹까지만 추가할 수 있습니다.', 'warning');
                return;
            }

            groupCount++;
            const groupHtml = `
        <div class="keyword-group mb-3 p-3 border rounded bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0 fw-bold">키워드 그룹 ${groupCount}</label>
            </div>
            <input type="text" class="form-control mb-2" placeholder="그룹 이름" name="groupName[]" required>
            <input type="text" class="form-control keyword-input" placeholder="키워드 (쉼표로 구분)" name="keywords[]" required>
        </div>
    `;
            document.getElementById('keywordGroups').insertAdjacentHTML('beforeend', groupHtml);
        });

        // 키워드 그룹 제거
        document.getElementById('removeGroupBtn').addEventListener('click', function () {
            if (groupCount <= 1) {
                Swal.fire('알림', '최소 1개의 그룹이 필요합니다.', 'warning');
                return;
            }

            const groups = document.querySelectorAll('.keyword-group');
            groups[groups.length - 1].remove();
            groupCount--;
        });

        // 폼 제출
        document.getElementById('datalabForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const startDate = formData.get('startDate'); // YYYY-MM-DD 그대로
            const endDate = formData.get('endDate');
            const timeUnit = formData.get('timeUnit');
            const device = formData.get('device');
            const gender = formData.get('gender');

            const groupNames = formData.getAll('groupName[]');
            const keywordsArrays = formData.getAll('keywords[]');

            const keywordGroups = groupNames.map((name, index) => ({
                groupName: name,
                keywords: keywordsArrays[index].split(',').map(k => k.trim()).filter(k => k)
            }));

            // 선택된 연령대 가져오기
            let selectedAges = formData.getAll('ages[]');
            if (selectedAges.length === 0) {
                selectedAges = ["1", "2", "3", "4", "5", "6", "7"]; // 선택 안 하면 전체
            }


            const requestBody = {
                startDate,
                endDate,
                timeUnit,
                keywordGroups,
                ages: selectedAges

            };

            if (device) requestBody.device = device;
            if (gender) requestBody.gender = gender;

            document.getElementById('loadingSpinner').classList.remove('d-none');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            try {
                const response = await axios.post('/trends/datalab/search', requestBody);
                displayDatalabResults(response.data);
            } catch (error) {
                console.error('분석 오류:', error);
                Swal.fire({
                    icon: 'error',
                    title: '분석 실패',
                    text: error.response?.data?.message || '데이터 분석 중 오류가 발생했습니다.',
                });
            } finally {
                document.getElementById('loadingSpinner').classList.add('d-none');
                document.getElementById('searchBtn').disabled = false;
            }
        });

        function displayDatalabResults(data) {
            const resultsDiv = document.getElementById('searchResults');

            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = `
            <div class="alert alert-warning border-0 shadow-sm" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                분석 결과가 없습니다.
            </div>
        `;
                return;
            }

            let html = '<div class="card shadow-sm border-0 mb-4"><div class="card-body">';
            html += '<h5 class="card-title mb-4"><i class="bi bi-graph-up me-2"></i>트렌드 분석 결과</h5>';

            data.results.forEach((result, index) => {
                const color = ['primary', 'success', 'danger', 'warning', 'info'][index % 5];

                html += `
            <div class="mb-4">
                <h6 class="text-${color}">
                    <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>
                    ${result.title}
                </h6>
                <div class="mb-2">
                    <strong>키워드:</strong> ${result.keywords.join(', ')}
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>날짜</th>
                                <th>검색 비율</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.data.map(item => `
                                <tr>
                                    <td>${item.period}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-${color}" role="progressbar" 
                                                 style="width: ${item.ratio}%" 
                                                 aria-valuenow="${item.ratio}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                ${item.ratio}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            ${index < data.results.length - 1 ? '<hr>' : ''}
        `;
            });

            html += '</div></div>';
            resultsDiv.innerHTML = html;
        }
    </script>